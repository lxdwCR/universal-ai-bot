-- Clean ESP + Silent Aim (No Hooks) + Right Shift Menu
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

-- Configuration
local ESP_ENABLED = true
local SILENT_AIM_ENABLED = false
local PSILENT_ENABLED = false
local SHOW_FOV_CIRCLE = true
local BOX_COLOR = Color3.fromRGB(255, 0, 0)
local SILENT_AIM_COLOR = Color3.fromRGB(255, 165, 0)
local FOV_CIRCLE_COLOR = Color3.fromRGB(255, 255, 255)
local AIMBOT_FOV = 150
local AIMBOT_MAX_DISTANCE = 200

local localPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local menuVisible = true

-- Drawing objects
local fovCircle = Drawing.new("Circle")
local fovCircleCenter = Drawing.new("Circle")
local playerDrawings = {}

-- Silent aim variables
local silentAimTarget = nil
local lastMouseHit = nil

-- Setup FOV circle
fovCircle.Visible = false
fovCircle.Color = FOV_CIRCLE_COLOR
fovCircle.Thickness = 2
fovCircle.Radius = AIMBOT_FOV
fovCircle.Filled = false
fovCircle.NumSides = 32
fovCircle.Transparency = 0.7

fovCircleCenter.Visible = false
fovCircleCenter.Color = FOV_CIRCLE_COLOR
fovCircleCenter.Thickness = 1
fovCircleCenter.Radius = 2
fovCircleCenter.Filled = true
fovCircleCenter.Transparency = 0.8

-- UI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ESPGui"
ScreenGui.Parent = CoreGui
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 220, 0, 200)
MainFrame.Position = UDim2.new(0, 10, 0, 10)
MainFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 25)
Title.Position = UDim2.new(0, 0, 0, 0)
Title.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
Title.Text = "ESP + Silent [Right Shift]"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.SourceSans
Title.TextSize = 14
Title.Parent = MainFrame

local ESPButton = Instance.new("TextButton")
ESPButton.Size = UDim2.new(0, 90, 0, 25)
ESPButton.Position = UDim2.new(0.05, 0, 0.15, 0)
ESPButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
ESPButton.Text = "ESP: ON"
ESPButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ESPButton.Font = Enum.Font.SourceSans
ESPButton.TextSize = 12
ESPButton.Parent = MainFrame

local SilentButton = Instance.new("TextButton")
SilentButton.Size = UDim2.new(0, 90, 0, 25)
SilentButton.Position = UDim2.new(0.55, 0, 0.15, 0)
SilentButton.BackgroundColor3 = Color3.fromRGB(170, 100, 0)
SilentButton.Text = "Silent: OFF"
SilentButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SilentButton.Font = Enum.Font.SourceSans
SilentButton.TextSize = 12
SilentButton.Parent = MainFrame

local TargetLabel = Instance.new("TextLabel")
TargetLabel.Size = UDim2.new(0.9, 0, 0, 20)
TargetLabel.Position = UDim2.new(0.05, 0, 0.45, 0)
TargetLabel.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
TargetLabel.Text = "Target: None"
TargetLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TargetLabel.Font = Enum.Font.SourceSans
TargetLabel.TextSize = 11
TargetLabel.Parent = MainFrame

-- Player validation
local function isValidPlayer(player)
    return player and player ~= localPlayer and player.Character and 
           player.Character:FindFirstChild("Humanoid") and 
           player.Character:FindFirstChild("Head") and 
           player.Character.Humanoid.Health > 0
end

-- Get closest player
local function getClosestPlayer()
    local closestPlayer = nil
    local closestDistance = AIMBOT_FOV
    
    local camera = workspace.CurrentCamera
    local screenCenter = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    
    for _, player in pairs(Players:GetPlayers()) do
        if isValidPlayer(player) then
            local head = player.Character.Head
            local headPos, headVisible = camera:WorldToViewportPoint(head.Position)
            
            if headVisible and headPos.Z > 0 then
                local screenPos = Vector2.new(headPos.X, headPos.Y)
                local screenDistance = (screenPos - screenCenter).Magnitude
                
                local distance3D = (head.Position - camera.CFrame.Position).Magnitude
                if distance3D < AIMBOT_MAX_DISTANCE and screenDistance < closestDistance then
                    closestPlayer = player
                    closestDistance = screenDistance
                end
            end
        end
    end
    
    return closestPlayer
end

-- Create player ESP
local function createPlayerESP(player)
    local drawings = {
        box = Drawing.new("Square"),
        headCircle = Drawing.new("Circle"),
        healthBarBg = Drawing.new("Square"),
        healthBar = Drawing.new("Square"),
        nameLabel = Drawing.new("Text")
    }
    
    -- Configure drawings
    for _, drawing in pairs(drawings) do
        drawing.Visible = false
    end
    
    drawings.box.Color = BOX_COLOR
    drawings.box.Thickness = 2
    
    drawings.headCircle.Color = Color3.fromRGB(0, 255, 0)
    drawings.headCircle.Thickness = 2
    drawings.headCircle.Radius = 8
    
    drawings.healthBarBg.Color = Color3.fromRGB(0, 0, 0)
    drawings.healthBarBg.Filled = true
    
    drawings.healthBar.Color = Color3.fromRGB(0, 255, 0)
    drawings.healthBar.Filled = true
    
    drawings.nameLabel.Color = Color3.fromRGB(255, 255, 255)
    drawings.nameLabel.Size = 16
    drawings.nameLabel.Center = true
    drawings.nameLabel.Outline = true
    
    playerDrawings[player] = drawings
end

-- Update player ESP
local function updateESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player == localPlayer then continue end
        
        local drawings = playerDrawings[player]
        if not drawings then
            createPlayerESP(player)
            drawings = playerDrawings[player]
        end
        
        if isValidPlayer(player) and ESP_ENABLED and menuVisible then
            local character = player.Character
            local humanoid = character.Humanoid
            local head = character.Head
            local rootPart = character.HumanoidRootPart
            
            local headPos, headVisible = Camera:WorldToViewportPoint(head.Position)
            local rootPos, rootVisible = Camera:WorldToViewportPoint(rootPart.Position)
            
            if headVisible and rootVisible and headPos.Z > 0 and rootPos.Z > 0 then
                -- Calculate box dimensions
                local topPos = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 1, 0))
                local bottomPos = Camera:WorldToViewportPoint(rootPart.Position - Vector3.new(0, 2, 0))
                
                local height = math.abs(topPos.Y - bottomPos.Y)
                local width = height * 0.45
                
                width = math.max(width, 25)
                height = math.max(height, 40)
                
                -- Update box
                drawings.box.Size = Vector2.new(width, height)
                drawings.box.Position = Vector2.new(rootPos.X - width/2, topPos.Y)
                drawings.box.Visible = true
                
                -- Update head circle
                drawings.headCircle.Position = Vector2.new(headPos.X, headPos.Y)
                drawings.headCircle.Visible = (SILENT_AIM_ENABLED or PSILENT_ENABLED) and player == silentAimTarget
                drawings.headCircle.Color = PSILENT_ENABLED and Color3.fromRGB(255, 0, 255) or SILENT_AIM_COLOR
                
                -- Update health bar
                local healthPercent = math.clamp(humanoid.Health / humanoid.MaxHealth, 0, 1)
                local barWidth = width - 4
                local barHeight = 4
                
                drawings.healthBarBg.Size = Vector2.new(barWidth + 2, barHeight + 2)
                drawings.healthBarBg.Position = Vector2.new(rootPos.X - barWidth/2 - 1, topPos.Y - 8)
                drawings.healthBarBg.Visible = true
                
                drawings.healthBar.Size = Vector2.new(barWidth * healthPercent, barHeight)
                drawings.healthBar.Position = Vector2.new(rootPos.X - barWidth/2, topPos.Y - 7)
                drawings.healthBar.Color = healthPercent > 0.6 and Color3.fromRGB(0, 255, 0) or 
                                          healthPercent > 0.3 and Color3.fromRGB(255, 255, 0) or 
                                          Color3.fromRGB(255, 0, 0)
                drawings.healthBar.Visible = true
                
                -- Update name label
                drawings.nameLabel.Text = player.Name
                drawings.nameLabel.Position = Vector2.new(rootPos.X, topPos.Y - 20)
                drawings.nameLabel.Visible = true
            else
                -- Hide all drawings
                for _, drawing in pairs(drawings) do
                    drawing.Visible = false
                end
            end
        else
            -- Hide all drawings
            for _, drawing in pairs(drawings) do
                drawing.Visible = false
            end
        end
    end
end

-- Silent aim without hooks - uses mouse targeting
local function applySilentAim()
    if not SILENT_AIM_ENABLED and not PSILENT_ENABLED then return end
    
    silentAimTarget = getClosestPlayer()
    
    if silentAimTarget and silentAimTarget.Character and silentAimTarget.Character:FindFirstChild("Head") then
        local targetHead = silentAimTarget.Character.Head
        local targetPos = targetHead.Position + Vector3.new(0, 0.5, 0)
        
        -- Add prediction for PSilent
        if PSILENT_ENABLED and silentAimTarget.Character:FindFirstChild("HumanoidRootPart") then
            local velocity = silentAimTarget.Character.HumanoidRootPart.Velocity
            targetPos = targetPos + velocity * 0.1
        end
        
        -- Store target position for bullet redirection
        lastMouseHit = targetPos
        
        -- Update target label
        TargetLabel.Text = "Target: " .. silentAimTarget.Name
    else
        TargetLabel.Text = "Target: None"
        lastMouseHit = nil
    end
end

-- Button handlers
ESPButton.MouseButton1Click:Connect(function()
    ESP_ENABLED = not ESP_ENABLED
    ESPButton.Text = ESP_ENABLED and "ESP: ON" or "ESP: OFF"
    ESPButton.BackgroundColor3 = ESP_ENABLED and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
end)

SilentButton.MouseButton1Click:Connect(function()
    if not PSILENT_ENABLED then
        SILENT_AIM_ENABLED = not SILENT_AIM_ENABLED
        SilentButton.Text = SILENT_AIM_ENABLED and "Silent: ON" or "Silent: OFF"
        SilentButton.BackgroundColor3 = SILENT_AIM_ENABLED and Color3.fromRGB(255, 165, 0) or Color3.fromRGB(170, 100, 0)
    else
        PSILENT_ENABLED = false
        SilentButton.Text = "Silent: OFF"
        SilentButton.BackgroundColor3 = Color3.fromRGB(170, 100, 0)
    end
end)

-- Keybinds
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.RightShift then
        menuVisible = not menuVisible
        MainFrame.Visible = menuVisible
        fovCircle.Visible = SHOW_FOV_CIRCLE and (SILENT_AIM_ENABLED or PSILENT_ENABLED) and menuVisible
        fovCircleCenter.Visible = SHOW_FOV_CIRCLE and (SILENT_AIM_ENABLED or PSILENT_ENABLED) and menuVisible
        
    elseif input.KeyCode == Enum.KeyCode.X then
        if not SILENT_AIM_ENABLED then
            PSILENT_ENABLED = not PSILENT_ENABLED
            SilentButton.Text = PSILENT_ENABLED and "PSilent: ON" or "Silent: OFF"
            SilentButton.BackgroundColor3 = PSILENT_ENABLED and Color3.fromRGB(255, 0, 255) or Color3.fromRGB(170, 100, 0)
        else
            PSILENT_ENABLED = true
            SILENT_AIM_ENABLED = false
            SilentButton.Text = "PSilent: ON"
            SilentButton.BackgroundColor3 = Color3.fromRGB(255, 0, 255)
        end
    end
end)

-- Player management
local function onPlayerAdded(player)
    if player == localPlayer then return end
    createPlayerESP(player)
end

local function onPlayerRemoving(player)
    if playerDrawings[player] then
        for _, drawing in pairs(playerDrawings[player]) do
            drawing:Remove()
        end
        playerDrawings[player] = nil
    end
end

-- Setup
for _, player in pairs(Players:GetPlayers()) do
    onPlayerAdded(player)
end

Players.PlayerAdded:Connect(onPlayerAdded)
Players.PlayerRemoving:Connect(onPlayerRemoving)

-- Main loop
RunService.RenderStepped:Connect(function()
    -- Update FOV circle
    local camera = workspace.CurrentCamera
    local screenCenter = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    fovCircle.Position = screenCenter
    fovCircle.Radius = AIMBOT_FOV
    fovCircle.Visible = SHOW_FOV_CIRCLE and (SILENT_AIM_ENABLED or PSILENT_ENABLED) and menuVisible
    fovCircleCenter.Position = screenCenter
    fovCircleCenter.Visible = SHOW_FOV_CIRCLE and (SILENT_AIM_ENABLED or PSILENT_ENABLED) and menuVisible
    
    -- Update colors based on mode
    if PSILENT_ENABLED then
        fovCircle.Color = Color3.fromRGB(255, 0, 255)
    elseif SILENT_AIM_ENABLED then
        fovCircle.Color = SILENT_AIM_COLOR
    else
        fovCircle.Color = FOV_CIRCLE_COLOR
    end
    
    -- Update ESP
    updateESP()
    
    -- Apply silent aim
    applySilentAim()
end)

print("Clean ESP + Silent Aim (No Hooks) + Right Shift Menu Loaded!")
print("Right Shift - Toggle Menu")
print("X - Toggle PSilent")
print("Silent aim works through mouse targeting - no camera interference")
